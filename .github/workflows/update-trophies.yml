name: Update Trophies in README

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-trophies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update trophy section in README
        env:
          GITHUB_USERNAME: DevRitesh08
        run: |
          python3 << 'EOF'
          import os
          import re

          username = os.getenv("GITHUB_USERNAME")
          if not username:
              print("❌ GITHUB_USERNAME not set")
              exit(1)

          trophy_img = f"https://github-profile-trophy.vercel.app/?username={username}&theme=onestar&margin-w=10"
          trophy_md = (
              '<a href="https://github.com/ryo-ma/github-profile-trophy">\n'
              f'  <img src="{trophy_img}" alt="trophy" />\n'
              '</a>'
          )

          readme_path = "README.md"
          with open(readme_path, "r", encoding="utf-8") as f:
              content = f.read()

          new_content = re.sub(
              r"<!-- TROPHY_SECTION_START -->(.*?)<!-- TROPHY_SECTION_END -->",
              f"<!-- TROPHY_SECTION_START -->\n{trophy_md}\n<!-- TROPHY_SECTION_END -->",
              content,
              flags=re.DOTALL,
          )

          if content != new_content:
              with open(readme_path, "w", encoding="utf-8") as f:
                  f.write(new_content)
              print("✅ README.md updated.")
          else:
              print("ℹ️ No changes to README.md.")
          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "Update trophies in README [CI]"
            git push
          else
            echo "No changes to commit"
